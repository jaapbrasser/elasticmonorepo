{% extends 'base.html' %}

{% block content %}
<canvas id="bgCanvas" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; background: #0d0221;"></canvas>

<div style="position: relative; z-index: 1;">
    <form method="POST" action="{{ url_for('handle_search') }}">
      <div class="mb-3">
          <input type="text" class="form-control" name="query" id="query" placeholder="Enter your search query" value="{{ query }}" autofocus 
                 style="background: rgba(13, 2, 33, 0.7); color: #00f2ff; border: 1px solid #3d1b5c; backdrop-filter: blur(5px);">
      </div>
    </form>
    
    {% if results %}
        <div class="row mb-3" style="color: #e0e0e0;">
            <div class="col-2 mt-2">
                <p><a href="javascript:history.back(1)" style="color: #ff00ff; text-decoration: none; font-weight: bold;">← Back</a></p>
                {% for agg in aggs %}
                    <h6 class="mt-3" style="color: #00f2ff; text-transform: uppercase; font-size: 0.75rem; letter-spacing: 1px;">{{ agg }}</h6>
                    {% for key, count in aggs[agg].items() %}
                        <form method="POST">
                            <input type="hidden" name="query" value="{{ agg|lower }}:{{key}} {{ query }}">
                            <button type="submit" class="btn btn-link btn-sm p-0 mb-1" style="color: #b026ff; text-decoration: none; display: block;" {% if aggs[agg]|length == 1 %} disabled{% endif %}>
                                {{ key }} <span style="opacity: 0.6;">({{ count }})</span>
                            </button>
                        </form>
                    {% endfor %}
                {% endfor %}
            </div>
            <div class="col-10">
                <div class="row mb-3 align-items-center">
                    <div class="col-sm-auto">
                        <small style="color: #888;">Showing {{ from_ + 1 }}-{{ from_ + results|length }} of {{ total }}</small>
                    </div>
                    {% if from_ > 0 %}
                        <div class="col-sm-auto">
                            <a href="javascript:history.back(1)" class="btn btn-outline-info btn-sm" style="border-color: #3d1b5c;">← Previous</a>
                        </div>
                    {% endif %}
                    {% if from_ + results|length < total %}
                        <div class="col-sm-auto">
                            <form method="POST">
                                <input type="hidden" name="query" value="{{ query }}">
                                <input type="hidden" name="from_" value="{{ from_ + results|length }}">
                                <button type="submit" class="btn btn-outline-info btn-sm" style="border-color: #3d1b5c;">Next →</button>
                            </form>
                        </div>
                    {% endif %}
                </div>

                {% for result in results %}
                    <div class="mb-4 p-3" style="background: rgba(255, 255, 255, 0.02); border-left: 3px solid #ff00ff; border-radius: 4px;">
                        <b><a href="{{ url_for('get_document', id=result._id) }}" style="color: #00f2ff; font-size: 1.15rem; text-decoration: none;">{{ result._source.name }}</a></b>
                        <p class="mt-1 mb-2" style="color: #ccc; line-height: 1.4;">{{ result._source.summary }}</p>
                        <small style="color: #777; font-size: 0.8rem;">
                            <span style="color: #b026ff;">Category:</span> {{ result._source.category }} | 
                            <span style="color: #b026ff;">Updated:</span> {{ result._source.updated_at | default(result._source.created_on) }}
                            {% if result._score %} | <i style="color: #00f2ff;">Score: {{ result._score }}</i>{% endif %}
                        </small>
                    </div>
                {% endfor %}
            </div>
        </div>
    {% elif request.method == 'POST' %}
        <p style="color: #ff00ff; font-weight: bold;">No results found.</p>
    {% endif %}
</div>

<script>
    const canvas = document.getElementById('bgCanvas');
    const ctx = canvas.getContext('2d');
    let shapes = [];
    let mouse = { x: -2000, y: -2000 }; // Start mouse off-screen

    function resize() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
    }
    
    window.addEventListener('resize', resize);
    window.addEventListener('mousemove', (e) => {
        mouse.x = e.clientX;
        mouse.y = e.clientY;
    });
    
    resize();

    class Shape {
        constructor() {
            this.init();
        }

        init() {
            this.x = Math.random() * canvas.width;
            this.y = Math.random() * canvas.height;
            this.size = Math.random() * 30 + 15;
            // Constant drift speeds
            this.speedX = (Math.random() - 0.5) * 0.4;
            this.speedY = (Math.random() - 0.5) * 0.4;
            this.rotation = Math.random() * Math.PI * 2;
            this.spin = (Math.random() - 0.5) * 0.005;
            this.sides = Math.floor(Math.random() * 3) + 3;
            this.baseColor = Math.random() > 0.5 ? {r: 0, g: 242, b: 255} : {r: 255, g: 0, b: 255};
        }

        draw() {
            const dx = mouse.x - this.x;
            const dy = mouse.y - this.y;
            const distance = Math.sqrt(dx * dx + dy * dy);
            const isNear = distance < 180;

            ctx.save();
            
            let drawX = this.x;
            let drawY = this.y;

            if (isNear) {
                // Subtle "Glitch" - random jumpy offsets when mouse is near
                drawX += (Math.random() - 0.5) * 6;
                drawY += (Math.random() - 0.5) * 6;
                ctx.strokeStyle = `rgba(255, 255, 255, 0.8)`;
                ctx.shadowBlur = 15;
                ctx.shadowColor = `rgb(${this.baseColor.r}, ${this.baseColor.g}, ${this.baseColor.b})`;
                ctx.lineWidth = 2;
            } else {
                ctx.strokeStyle = `rgba(${this.baseColor.r}, ${this.baseColor.g}, ${this.baseColor.b}, 0.2)`;
                ctx.shadowBlur = 0;
                ctx.lineWidth = 1;
            }

            ctx.translate(drawX, drawY);
            ctx.rotate(this.rotation);
            
            ctx.beginPath();
            for (let i = 0; i < this.sides; i++) {
                const angle = (i * 2 * Math.PI) / this.sides;
                const px = Math.cos(angle) * this.size;
                const py = Math.sin(angle) * this.size;
                if (i === 0) ctx.moveTo(px, py);
                else ctx.lineTo(px, py);
            }
            ctx.closePath();
            ctx.stroke();
            ctx.restore();
        }

        update() {
            this.x += this.speedX;
            this.y += this.speedY;
            this.rotation += this.spin;

            // Loop edges
            if (this.x < -100) this.x = canvas.width + 100;
            if (this.x > canvas.width + 100) this.x = -100;
            if (this.y < -100) this.y = canvas.height + 100;
            if (this.y > canvas.height + 100) this.y = -100;
        }
    }

    // Initialize shapes
    for (let i = 0; i < 20; i++) shapes.push(new Shape());

    function drawGrid() {
        ctx.strokeStyle = 'rgba(61, 27, 92, 0.15)';
        ctx.lineWidth = 1;
        for(let i = 0; i < canvas.width; i += 50) {
            ctx.beginPath(); ctx.moveTo(i, 0); ctx.lineTo(i, canvas.height); ctx.stroke();
        }
        for(let i = 0; i < canvas.height; i += 50) {
            ctx.beginPath(); ctx.moveTo(0, i); ctx.lineTo(canvas.width, i); ctx.stroke();
        }
    }

    function animate() {
        // Clear with a slight trail effect
        ctx.fillStyle = '#0d0221';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        drawGrid();

        shapes.forEach(s => {
            s.update();
            s.draw();
        });

        // Scanline effect
        ctx.fillStyle = 'rgba(13, 2, 33, 0.2)';
        for (let i = 0; i < canvas.height; i += 4) {
            ctx.fillRect(0, i, canvas.width, 1);
        }

        requestAnimationFrame(animate);
    }
    animate();
</script>
{% endblock %}